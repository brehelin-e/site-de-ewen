<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - QCM Stockage</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet"/>
  <style>
    body {
      background: #0b0c10;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #1f1f2e;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(255, 77, 109, 0.2);
    }
    h1 {
      text-align: center;
      color: #ff4d6d;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .stat-card {
      background: #14151c;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-value {
      font-size: 48px;
      color: #ff4d6d;
      font-weight: bold;
    }
    .stat-label {
      color: #aaa;
      margin-top: 10px;
      font-size: 14px;
    }
    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }
    button {
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      background: #ff4d6d;
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s;
    }
    button:hover {
      background: #ff3355;
      transform: scale(1.02);
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    button.secondary {
      background: #444;
    }
    button.secondary:hover {
      background: #555;
    }
    .results-table {
      background: #14151c;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    th {
      color: #ff4d6d;
      font-weight: bold;
    }
    tr:hover {
      background: #1a1a2e;
    }
    .chart-container {
      background: #14151c;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }
    .chart-bar {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    .chart-label {
      width: 80px;
      color: #aaa;
    }
    .chart-bar-fill {
      height: 30px;
      background: linear-gradient(90deg, #ff4d6d, #ff3355);
      border-radius: 5px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      transition: all 0.3s;
    }
    .json-viewer {
      background: #14151c;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
      max-height: 400px;
      overflow-y: auto;
    }
    pre {
      margin: 0;
      color: #4caf50;
      font-size: 12px;
    }
    .import-section {
      background: #14151c;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    .file-input-label {
      display: block;
      padding: 15px;
      background: #444;
      color: white;
      text-align: center;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .file-input-label:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Administration QCM</h1>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalParticipants">0</div>
        <div class="stat-label">Total Participants</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgScore">0</div>
        <div class="stat-label">Score Moyen</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="maxScore">0</div>
        <div class="stat-label">Meilleur Score</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="perfectScores">0</div>
        <div class="stat-label">Scores Parfaits (5/5)</div>
      </div>
    </div>

    <div class="actions">
      <button onclick="downloadJSON()">üíæ T√©l√©charger JSON</button>
      <button onclick="downloadCSV()">üìä T√©l√©charger CSV</button>
      <button class="secondary" onclick="viewJSON()">üëÅÔ∏è Voir JSON</button>
      <button class="secondary" onclick="showImport()">üì• Importer JSON</button>
      <button class="danger" onclick="clearData()">üóëÔ∏è Effacer toutes les donn√©es</button>
    </div>

    <div class="chart-container">
      <h2 style="color: #ff4d6d; margin-bottom: 20px;">üìä Distribution des scores</h2>
      <div id="scoreDistribution"></div>
    </div>

    <div class="results-table">
      <h2 style="color: #ff4d6d; margin-bottom: 20px;">üìã Tous les r√©sultats</h2>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Utilisateur</th>
            <th>Score</th>
            <th>Q1</th>
            <th>Q2</th>
            <th>Q3</th>
            <th>Q4</th>
            <th>Q5</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
      </table>
    </div>

    <div class="json-viewer" id="jsonViewer" style="display: none;">
      <h2 style="color: #ff4d6d; margin-bottom: 20px;">üìÑ Donn√©es JSON</h2>
      <pre id="jsonContent"></pre>
    </div>

    <div class="import-section" id="importSection" style="display: none;">
      <h2 style="color: #ff4d6d; margin-bottom: 20px;">üì• Importer des donn√©es</h2>
      <div class="file-input-wrapper">
        <input type="file" id="jsonFile" accept=".json" onchange="importJSON(event)">
        <label for="jsonFile" class="file-input-label">
          üìÅ Choisir un fichier JSON
        </label>
      </div>
      <p style="color: #aaa; margin-top: 10px; text-align: center;">
        Importe un fichier JSON pour fusionner les r√©sultats
      </p>
    </div>
  </div>

<script>
const correctAnswers = { q1: "A", q2: "A", q3: "B", q4: "C", q5: "A" };

window.onload = function() {
  loadStats();
  loadTable();
  loadChart();
};

function loadStats() {
  const allResults = JSON.parse(localStorage.getItem("quizResults") || "[]");
  
  if (allResults.length === 0) {
    return;
  }

  const total = allResults.length;
  const avgScore = (allResults.reduce((sum, r) => sum + r.score, 0) / total).toFixed(1);
  const maxScore = Math.max(...allResults.map(r => r.score));
  const perfectScores = allResults.filter(r => r.score === 5).length;

  document.getElementById("totalParticipants").textContent = total;
  document.getElementById("avgScore").textContent = avgScore + "/5";
  document.getElementById("maxScore").textContent = maxScore + "/5";
  document.getElementById("perfectScores").textContent = perfectScores;
}

function loadTable() {
  const allResults = JSON.parse(localStorage.getItem("quizResults") || "[]");
  const tbody = document.getElementById("resultsBody");
  
  if (allResults.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #aaa;">Aucun r√©sultat pour le moment</td></tr>';
    return;
  }

  const html = allResults.map((result, index) => {
    const date = new Date(result.date).toLocaleString('fr-FR');
    const answers = result.answers || {};
    
    return `
      <tr>
        <td>${index + 1}</td>
        <td>${result.username}</td>
        <td style="color: #ff4d6d; font-weight: bold;">${result.score}/5</td>
        <td style="color: ${answers.q1 === correctAnswers.q1 ? '#4caf50' : '#f44336'}">${answers.q1 || '-'}</td>
        <td style="color: ${answers.q2 === correctAnswers.q2 ? '#4caf50' : '#f44336'}">${answers.q2 || '-'}</td>
        <td style="color: ${answers.q3 === correctAnswers.q3 ? '#4caf50' : '#f44336'}">${answers.q3 || '-'}</td>
        <td style="color: ${answers.q4 === correctAnswers.q4 ? '#4caf50' : '#f44336'}">${answers.q4 || '-'}</td>
        <td style="color: ${answers.q5 === correctAnswers.q5 ? '#4caf50' : '#f44336'}">${answers.q5 || '-'}</td>
        <td style="font-size: 12px; color: #aaa;">${date}</td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = html;
}

function loadChart() {
  const allResults = JSON.parse(localStorage.getItem("quizResults") || "[]");
  const distribution = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

  allResults.forEach(r => {
    distribution[r.score]++;
  });

  const maxCount = Math.max(...Object.values(distribution));
  const chartHTML = Object.entries(distribution).map(([score, count]) => {
    const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
    return `
      <div class="chart-bar">
        <div class="chart-label">${score}/5</div>
        <div class="chart-bar-fill" style="width: ${percentage}%;">
          ${count} participant${count > 1 ? 's' : ''}
        </div>
      </div>
    `;
  }).join("");

  document.getElementById("scoreDistribution").innerHTML = chartHTML || '<p style="color: #aaa;">Aucune donn√©e</p>';
}

function downloadJSON() {
  const allResults = JSON.parse(localStorage.getItem("quizResults") || "[]");
  
  const data = {
    totalParticipants: allResults.length,
    averageScore: allResults.length > 0 ? 
      (allResults.reduce((sum, r) => sum + r.score, 0) / allResults.length).toFixed(2) : 0,
    results: allResults,
    exportedAt: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `qcm-results-${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadCSV() {
  const allResults = JSON.parse(localStorage.getItem("quizResults") || "[]");
  
  let csv = "Utilisateur,Score,Q1,Q2,Q3,Q4,Q5,Date\n";
  allResults.forEach(result => {
    const date = new Date(result.date).toLocaleString('fr-FR');
    const answers = result.answers || {};
    csv += `${result.username},${result.score},${answers.q1 || '-'},${answers.q2 || '-'},${answers.q3 || '-'},${answers.q4 || '-'},${answers.q5 || '-'},${date}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `qcm-results-${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function viewJSON() {
  const viewer = document.getElementById("jsonViewer");
  const allResults = JSON.parse(localStorage.getItem("quizResults") || "[]");
  
  if (viewer.style.display === "none") {
    document.getElementById("jsonContent").textContent = JSON.stringify(allResults, null, 2);
    viewer.style.display = "block";
  } else {
    viewer.style.display = "none";
  }
}

function showImport() {
  const section = document.getElementById("importSection");
  section.style.display = section.style.display === "none" ? "block" : "none";
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      const existing = JSON.parse(localStorage.getItem("quizResults") || "[]");
      
      // Fusionner les donn√©es
      const merged = [...existing, ...(imported.results || imported)];
      localStorage.setItem("quizResults", JSON.stringify(merged));
      
      alert(`‚úÖ ${(imported.results || imported).length} r√©sultats import√©s avec succ√®s !`);
      location.reload();
    } catch (error) {
      alert("‚ùå Erreur : fichier JSON invalide");
    }
  };
  reader.readAsText(file);
}

function clearData() {
  if (confirm("‚ö†Ô∏è Es-tu s√ªr de vouloir effacer TOUTES les donn√©es ? Cette action est irr√©versible !")) {
    if (confirm("üö® DERNI√àRE CONFIRMATION : Toutes les donn√©es seront perdues !")) {
      localStorage.removeItem("quizResults");
      localStorage.removeItem("lastResult");
      localStorage.removeItem("currentUser");
      alert("‚úÖ Toutes les donn√©es ont √©t√© effac√©es");
      location.reload();
    }
  }
}
</script>

</body>
</html>